<button class="add-friend-btn btn" (click)="toggleFinder()" aria-label="Find friends">
  <img src="/add-user.png" alt="" class="logo" />
  <span class="label">Find friends</span>
</button>

<!-- Back-drop (clicking it closes the popup) -->
<div class="overlay" *ngIf="showFinder" (click)="toggleFinder()">

<!-- Popup card in the top-right -->
  <div class="popup" *ngIf="showFinder" (click)="$event.stopPropagation()">
    <div class="find-friends-container">

      <h3>Find Friends</h3>

      <div class="search-bar">
        <form (ngSubmit)="findUser()">
          <input type="search" class="form-control" [(ngModel)]="friendToSearch" name="friend" placeholder="Enter username…">
          <button class="btn">Search</button>
        </form>
      </div>

      <div *ngIf="searchResult" class="search-res">
        <span>{{ searchResult.username }}</span>
        <button class="btn" (click)="sendRequest(searchResult.id)" [disabled]="pendingAdd">
          {{ pendingAdd ? 'Pending' : 'Add Friend' }}
        </button>
      </div>

      <p *ngIf="error">{{ error }}</p>
    </div>
  </div>
</div>

<!--tab-->
<nav class="friend-tabs">
  <button class="tab btn" [class.active]="tab==='friends'" (click)="tab='friends'">Friends</button>
  <button class="tab btn" [class.active]="tab==='requests'" (click)="tab='requests'">Requests
    <span *ngIf="incoming.length" class="badge">{{ incoming.length }}</span>
  </button>
</nav>


<section *ngIf="tab==='friends'">
  <h2 class="heading">Your Friends</h2>

  <div class="friend-list" *ngIf="friends.length; else noFriends">
    <article *ngFor="let f of friends" class="friend-card">

      <!-- right-top menu -->
      <button class="menu-btn btn" (click)="toggleMenu(f.id, 'friend')">⋮</button>

      <!-- left column --------------------------------------------------->
      <div class="left-col">
        <h4 class="username">{{ f.username }}</h4>
<!--        …-->
        <div class="last-went">
          <div class="caption">went gym</div>
          <div class="value">
            <span class="lg">{{ daysAgoParts(f.lastWorkoutAt).big }}</span>
            <span class="sm" *ngIf="daysAgoParts(f.lastWorkoutAt).small">
        {{ daysAgoParts(f.lastWorkoutAt).small }}
      </span>
          </div>
        </div>
      </div>

      <!-- middle column ------------------------------------------------->
      <div class="middle-col">

        <div class="mr-title">Most recent lift:</div>
        <ng-container *ngIf="f.mostRecentLift; else noLift">
          <div class="lift-name">
            {{ humanizeLift(f.mostRecentLift!.liftName) }}
          </div>

          <div class="set-pills">
            <div class="pill" *ngFor="let s of f.mostRecentLift!.sets; let i = index">
              <span class="pill-set">Set {{ i + 1 }}</span>
              <span class="sep">•</span>
              <span class="pill-weight">{{ s.weightKg }}kg</span>
              <span class="sep">×</span>
              <span class="pill-reps">{{ s.reps }} reps</span>
            </div>
          </div>
        </ng-container>

        <ng-template #noLift>
          <div class="muted">No lifts recorded on last session.</div>
        </ng-template>
      </div>

      <!-- right column -------------------------------------------------->
      <div class="right-col">
        <button class="compare-btn btn" (click)="compareWith(f.id)">Compare →</button>
      </div>

      <!-- pop-over -->
      <div class="popover" *ngIf="openMenuId===f.id && openMenuType==='friend'">
        <button class="btn danger" (click)="removeFriend(f.id)">Remove friend</button>
      </div>
<!--      <button class="menu-btn btn"-->
<!--              (click)="toggleMenu(f.id, 'friend')">⋮</button>-->
<!--&lt;!&ndash;      ⋯&ndash;&gt;-->
<!--      <h4>{{ f.username }}</h4>-->
<!--      &lt;!&ndash; New: last workout line &ndash;&gt;-->
<!--&lt;!&ndash;      <div class="subline">&ndash;&gt;-->
<!--&lt;!&ndash;        Last went gym: {{ daysAgoLabel(f.lastWorkoutAt) }}&ndash;&gt;-->
<!--&lt;!&ndash;      </div>&ndash;&gt;-->

<!--&lt;!&ndash;      &lt;!&ndash; New: most recent lift and sets &ndash;&gt;&ndash;&gt;-->
<!--&lt;!&ndash;      <div class="most-recent" *ngIf="f.mostRecentLift; else noLift">&ndash;&gt;-->
<!--&lt;!&ndash;        <div class="title">Most recent lift: {{ f.mostRecentLift!.liftName }}</div>&ndash;&gt;-->
<!--&lt;!&ndash;        <ul class="sets">&ndash;&gt;-->
<!--&lt;!&ndash;          <li *ngFor="let s of f.mostRecentLift!.sets; let i = index">&ndash;&gt;-->
<!--&lt;!&ndash;            Set {{ i + 1 }} — {{ s.weightKg }} kg × {{ s.reps }} Reps&ndash;&gt;-->
<!--&lt;!&ndash;          </li>&ndash;&gt;-->
<!--&lt;!&ndash;        </ul>&ndash;&gt;-->
<!--&lt;!&ndash;      </div>&ndash;&gt;-->
<!--&lt;!&ndash;      <ng-template #noLift>&ndash;&gt;-->
<!--&lt;!&ndash;        <div class="muted">No lifts recorded on last session.</div>&ndash;&gt;-->
<!--&lt;!&ndash;      </ng-template>&ndash;&gt;-->
<!--      <button class="compare-btn btn"-->
<!--              (click)="compareWith(f.id)">Compare →</button>-->

<!--      &lt;!&ndash; pop-over &ndash;&gt;-->
<!--      <div class="popover"-->
<!--           *ngIf="openMenuId===f.id && openMenuType==='friend'">-->
<!--        <button class="btn" (click)="removeFriend(f.id)">Remove friend</button>-->
<!--      </div>-->
    </article>
  </div>

  <ng-template #noFriends>
    <p class="empty">No friends at the moment.</p>
  </ng-template>
</section>

<section *ngIf="tab==='requests'">
  <h2 class="heading">Incoming Requests</h2>

  <ul class="request-list" *ngIf="incoming.length; else noReq">
    <li *ngFor="let r of incoming" class="request-tube">
      <span class="name">{{ r.senderUsername }}</span>

      <button class="icon-btn btn" (click)="actOnRequest(r,'accept')"
              [disabled]="busyIds.has(r.requestId)">Accept</button>

      <button class="icon-btn btn" (click)="actOnRequest(r,'decline')"
              [disabled]="busyIds.has(r.requestId)">✕</button>
    </li>
  </ul>

  <ng-template #noReq>
    <p class="empty">No incoming friend requests.</p>
  </ng-template>
</section>
